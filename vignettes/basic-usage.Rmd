---
title: "Using the ScPCAr package to access Single-cell Pediatric Cancer Atlas data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using the ScPCAr package to access Single-cell Pediatric Cancer Atlas data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| include: FALSE
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

The ScPCAr package provides an interface to interact with the Single-cell Pediatric Cancer Atlas (ScPCA) Portal API.
This vignette demonstrates the basic workflow for discovering, downloading, and working with ScPCA data.

This vignette covers the following tasks for interacting with the ScPCA Portal:

1. Listing available projects
2. Selecting a project and exploring its samples
3. Obtaining an authentication token
4. Downloading data for individual samples
5. Loading the data into R

# Installing the ScPCAr Package

The ScPCAr package is currently available via GitHub.
You can install the latest version using the `remotes` package:

```{r install}
#| eval: FALSE
# Install remotes if you don't have it
if (!requireNamespace("remotes", quietly = TRUE)) {
  install.packages("remotes")
}
# Install ScPCAr from GitHub
remotes::install_github("Alexslemonade/ScPCAr")
```

We will now also load the `SingleCellExperiment` package for later analysis.

```{r setup}
library(ScPCAr)
library(SingleCellExperiment)
```

# Exploring available projects

## Listing all projects

First, let's see what projects are available in the ScPCA Portal:

```{r list-projects}
# Get a data frame of all projects
projects <- ScPCAr::scpca_projects()
# print out the data frame (without abstracts for brevity)
projects |>
  dplyr::select(!abstract) |>
  head()
```

The `scpca_projects()` function returns a data frame with basic project metadata.
By default, it returns a simplified version with list columns removed for easier viewing.
You can see the full structure with additional data such as a list of diagnoses, data types, external accession numbers, etc., by setting `simplify = FALSE`:

```{r list-projects-full}
# Get the full project information including list columns
projects_full <- ScPCAr::scpca_projects(simplify = FALSE)

# View the structure of the full data frame
dplyr::glimpse(projects_full)
```


## Getting detailed project information

Now let's get more detailed information about the samples in a selected project.
We will use the first project, `SCPCP000001`, as an example.
According to the project info above, these samples are from a study of pediatric high-grade gliomas.
We can get more detailed information about this project using its `project_id`, and here we will set `simplifyVector = TRUE` to convert simple lists into vectors where possible.

```{r project-info}
project_id <- "SCPCP000001"
# Get detailed project metadata
project_info <- ScPCAr::get_project_info(project_id)
```

This returns a `list` with more detailed information about the project and the samples within.
You can explore the full structure of this list with `str()` or `dplyr::glimpse()`, but for now we will just look at a few of the components that might be of interest.

For example, we can look at the set of diagnoses that are present, and their counts:

```{r project-diagnoses}
project_info$diagnoses_counts
```

Similarly, we can look at the data modalities available for this project, which here includes both single-cell and bulk RNA-seq data:

```{r project-modalities}
project_info$modalities
```


# Exploring sample information

## Getting sample metadata

Let's look at the samples within our selected project:

```{r sample-info}
# Get sample information for the project
samples <- ScPCAr::get_project_samples(project_id)
head(samples)

# Examine sample characteristics
table(samples$organism)
table(samples$age_group)
table(samples$diagnosis)

# Select an interesting sample
selected_sample_id <- samples$scpca_sample_id[1]
print(paste("Selected sample:", selected_sample_id))
```

## Getting detailed sample information

We can also get detailed information for a specific sample:

```{r detailed-sample}
# Get detailed sample metadata
sample_detail <- ScPCAr::get_sample_info(selected_sample_id)
str(sample_detail, max.level = 2)

# Check what data types are available for this sample
print("Available modalities:")
print(sample_detail$modalities)
```

# Authentication

To download actual data files, you need an authentication token.
You obtain this by providing your email address and agreeing to the terms of service.
To view the terms of service in a web browser, run `ScPCAr::view_terms()`.

```{r auth}
#| eval: FALSE
# Get an authentication token
# Replace with your actual email address
my_email <- "your.email@example.com"
auth_token <- ScPCAr::get_auth(email = my_email, agree = TRUE)
```

```{r auth_hidden}
#| eval: TRUE
#| echo: FALSE
auth_token <- ScPCAr::get_auth("scpca@alexslemonade.org", agree = TRUE)
```

**Important Notes:**

- You must set `agree = TRUE` to indicate you accept the terms of service
- Replace `"your.email@example.com"` with your actual email address
- The token is tied to your email and the terms of service agreement
- Keep your token secure and don't share it publicly

# Downloading and loading SingleCellExperiment data

## Downloading sample data

Now we can download data for our selected sample.
We will use the `download_sample()` function, specifying the sample ID, authentication token, desired destination directory, and the file format.
The function will download and unpack the files associated with that sample, and return a list of file paths for the downloaded files
Let's start with SingleCellExperiment format:

```{r download-sce}
# Download SingleCellExperiment data for our sample
# This will create a directory structure under "scpca_data/"
file_paths <- ScPCAr::download_sample(
  sample_id = "SCPCS000001",
  auth_token = auth_token,
  destination = "scpca_data",
  format = "sce"
)

# Check what files were downloaded
print(file_paths)
```

## Understanding the downloaded file structure

A standard download of SingleCellExperiment data for a sample will create a directory structure like this:

```
scpca_data/
└── {sample_id}_{MODALITY}_{FORMAT}_{YYYY-MM-DD}/
    ├── README.md
    ├── single_cell_metadata.tsv
    ├── {sample_id}_filtered.rds
    ├── {sample_id}_processed.rds
    ├── {sample_id}_unfiltered.rds
    ├── {sample_id}_qc.html
    └── {sample_id}_celltype-report.html

```

For details about the contents of these files, see the [ScPCA Portal documentation](https://scpca.readthedocs.io/en/latest/download_files.html).


## Loading data into R

Now let's load in the processed data for our sample.
First we will select the processed SingleCellExperiment file from the downloaded paths, then use `readRDS()` to load it.

```{r load-sce}
# select the processed SCE file using a pattern match for the file name.
processed_sce <- stringr::str_subset(file_paths, "_processed\\.rds$")

# Load the SingleCellExperiment object
sce <- readRDS(processed_sce)

# View a summary of the object
sce
```

## Working with the SingleCellExperiment object

Once loaded, you can work with the SingleCellExperiment object using standard Bioconductor tools:

```{r work-with-sce}
# Access count data
counts <- counts(sce)
dim(counts)

# Access cell metadata
cell_metadata <- colData(sce)
head(cell_metadata)

# Access gene metadata
gene_metadata <- rowData(sce)
head(gene_metadata)

# View the UMAP, colored by consensus cell type
scater::plotUMAP(sce, color_by = "consensus_celltype_annotation")
```

# Working with H5AD/AnnData Format

ScPCAr also supports downloading data in H5AD (AnnData) format, which is commonly used in Python-based single-cell analysis workflows:

```{r h5ad-discussion}
# Download the same sample in H5AD format
# file_paths_h5ad <- ScPCAr::download_sample(
#   sample_id = selected_sample_id,
#   auth_token = auth_token,
#   destination = "scpca_data",
#   format = "anndata"
# )
```

**Note about H5AD files:**
- H5AD files can be read into R using packages like `zellkonverter` or `anndata`
- These files are particularly useful if you're planning to analyze data in Python
- The H5AD format preserves similar information to SingleCellExperiment but in a different structure
- For R-based analysis, we recommend using the SingleCellExperiment format shown above

To work with H5AD files in R, you would typically:
```{r h5ad-loading, eval=FALSE}
# Install zellkonverter if not already installed
# BiocManager::install("zellkonverter")

# Load H5AD file (example - not run)
# library(zellkonverter)
# h5ad_file <- list.files(data_dir, pattern = "\\.h5ad$", full.names = TRUE)[1]
# sce_from_h5ad <- zellkonverter::readH5AD(h5ad_file)
```

# Summary

This vignette demonstrated the basic ScPCAr workflow:

1. **Discovery**: Use `ScPCAr::scpca_projects()` to explore available projects
2. **Selection**: Choose projects and samples of interest using the metadata
3. **Authentication**: Obtain a token with `ScPCAr::get_auth()` using your email
4. **Download**: Use `ScPCAr::download_sample()` to get data files
5. **Loading**: Load SingleCellExperiment objects with `readRDS()`
6. **Analysis**: Work with the data using standard Bioconductor tools

The ScPCAr package makes it straightforward to access the rich collection of pediatric cancer single-cell data from the ScPCA Portal and integrate it into your R-based analysis workflows.

For more advanced usage, including downloading entire projects, working with spatial data, and batch processing multiple samples, see the additional package documentation and function help pages.
